name: cuda-ci

on:
  workflow_dispatch:
    inputs:
      run_extended:
        description: "Run extended CUDA checks (gpuRIR comparison)"
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "0 6 * * 1-5"
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
      - labeled
    paths:
      - ".github/workflows/cuda-ci.yml"
      - "pyproject.toml"
      - "uv.lock"
      - "src/**"
      - "tests/**"

concurrency:
  group: cuda-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  cuda-smoke:
    name: CUDA smoke tests
    if: >-
      github.event_name != 'pull_request' ||
      contains(github.event.pull_request.labels.*.name, 'cuda-ci')
    runs-on:
      - self-hosted
      - linux
      - x64
      - cuda
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v5

      - name: Show GPU info
        run: nvidia-smi

      - name: Install dependencies
        run: uv sync --group test

      - name: Verify torchrir import and CUDA
        run: |
          uv run python -c "import torch, torchrir; print('torch', torch.__version__); print('cuda_available', torch.cuda.is_available()); assert torch.cuda.is_available(), 'CUDA is not available on this runner'"

      - name: Run CUDA parity tests
        run: uv run pytest -q tests/test_device_parity.py -k cuda

  cuda-extended:
    name: CUDA extended checks
    if: >-
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_extended == 'true') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'cuda-extended'))
    runs-on:
      - self-hosted
      - linux
      - x64
      - cuda
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - uses: astral-sh/setup-uv@v5

      - name: Show GPU info
        run: nvidia-smi

      - name: Install dependencies
        run: uv sync --group test

      - name: Verify torchrir import and CUDA
        run: |
          uv run python -c "import torch, torchrir; print('torch', torch.__version__); print('cuda_available', torch.cuda.is_available()); assert torch.cuda.is_available(), 'CUDA is not available on this runner'"

      - name: Install gpuRIR (optional)
        id: install-gpurir
        continue-on-error: true
        run: uv pip install https://github.com/DavidDiazGuerra/gpuRIR.git

      - name: Run gpuRIR comparison tests
        if: steps.install-gpurir.outcome == 'success'
        run: uv run pytest -q tests/test_compare_gpurir.py

      - name: Skip gpuRIR comparison tests
        if: steps.install-gpurir.outcome != 'success'
        run: echo "Skipping gpuRIR comparison tests because gpuRIR installation failed."
